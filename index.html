<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Okey 101 Skor Takip Sistemi</title>
<style>

input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type=number] {
  -moz-appearance: textfield;
}

body {
  font-family: "Segoe UI", sans-serif;
  background: #f3f6fb;
  color: #2c3e50;
  margin: 0;
  padding: 0;
}

h1 {
  text-align: center;
  padding: 20px;
  background: #4a90e2;
  color: white;
  margin: 0 0 20px;
}

.container {
  max-width: 1100px;
  margin: auto;
  background: white;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  padding: 20px;
}

label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  font-size: 14px;
}

input,
select {
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  width: 50%;
  box-sizing: border-box;
  font-size: 14px;
  height: 36px;
  background-color: #fff;
}

input:focus,
select:focus {
  outline: none;
  border-color: #4a90e2;
  box-shadow: 0 0 4px rgba(74, 144, 226, 0.4);
}

/* 🧾 TABLO – klasik eski tasarım */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th,
td {
  border: 1px solid #ddd;
  text-align: center;
  vertical-align: middle;
  padding: 8px;
}

th {
  background: #4a90e2;
  color: white;
}

.player-cell {
  font-size: 13px;
  text-align: center;
}

/* 🟦 Kategoriler */
.kategori {
  border: 1px solid #eee;
  margin: 2px;
  padding: 4px;
  border-radius: 6px;
  background: #f9f9f9;
}

.kategori h4 {
  margin: 2px 0;
  font-size: 13px;
  color: #4a90e2;
}

/* 🟩 Seçenek kutuları */
.secenek {
  display: inline-block;
  margin: 4px 6px;
  padding: 3px 6px;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.2s;
}

.secenek:hover {
  background: #e0edff;
}

.secenek.aktif {
  background: #2ecc71;
  color: white;
  font-weight: bold;
}

/* 🟥 Ceza satırları */
.ceza-satiri {
  margin: 3px 0;
}

.ceza-satiri button {
  width: 25px;
  height: 25px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  color: white;
  font-weight: bold;
  font-size: 14px;
}

.ceza-satiri .azalt {
  background: #e74c3c;
}

.ceza-satiri .azalt:hover {
  background: #c0392b;
}

.ceza-satiri .artir {
  background: #2ecc71;
}

.ceza-satiri .artir:hover {
  background: #27ae60;
}

/* 🔹 FORM DÜZENLERİ */
.yan-yana {
  display: flex;
  gap: 0px;
  align-items: flex-end;
}

.yan-yana > div {
  flex: 1;
}

.oyuncu-grup {
  display: flex;
  gap: 0px;
  flex-wrap: wrap;
  justify-content: space-between;
}

.oyuncu-grup div {
  flex: 1 1 45%;
  min-width: 200px;
}

.oyuncu-grup label {
  display: block;
  margin-bottom: 5px;
  text-align: left;
}

/* 🔹 GENEL GÖRSEL DENGE */
.section-title {
  background: #e9f0ff;
  padding: 10px;
  font-weight: bold;
  border-radius: 6px;
  font-size: 15px;
  color: #2c3e50;
  text-align: center;
}

/* 🔹 Butonlar */
.btn {
  background: #4a90e2;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 20px;
  font-weight: bold;
  width: 100%;
}

.btn:hover {
  background: #357abd;
}

.hidden {
  display: none;
}

/* 🔹 Sayı input oklarını kaldır */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type=number] {
  -moz-appearance: textfield;
}


	
</style>
</head>
<body>
<h1>🟢 Okey 101 Skor Takip Sistemi</h1>

<!-- GİRİŞ EKRANI -->
<div class="container" id="ayarEkrani">
  <div class="section-title">Ayarlar</div>
<div class="yan-yana">
  <div style="width:50%;">
    <label>Oyun Türü:</label>
    <select id="oyunTuru" onchange="oyunTuruDegisti()">
      <option value="tek">Tekli</option>
      <option value="esli">Eşli</option>
    </select>
  </div>
  <div style="width:50%;">
    <label>Oynanacak Tur Sayısı</label>
    <input type="number" id="tur" min="3" max="33" value="3">
  </div>
</div>
  <div id="esliSecenekleri" class="hidden">
    <label>Eşli Oyun Tipi:</label>
    <select id="esliTipi" onchange="oyunTuruDegisti()">
      <option value="birlikte">Takım puanlı</option>
      <option value="ayri">Bireysel puanlı</option>
    </select>
  </div>
  <div class="section-title">Oyuncu/Takım İsimleri</div>
  <div id="isimler"></div>
	<div class="section-title">Oyun Puanlama</div>
	<div style="display:flex;gap:0px;">
      <div style="width:50%;">
	    
	    <label>Bitirme (-)</label><input type="number" id="p_bitirme" value="-101">
	    <label>Elden Bitirme (-)</label><input type="number" id="p_eldenbit" value="-202">		
	    <label>Çiftle Bitirme (-)</label><input type="number" id="p_ciftbit" value="-202">
      </div>
      <div style="width:50%;">
	    <label>Açamama (+)</label><input type="number" id="p_acamama" value="202">
		<label>Masa Sayısını Aşma (-)</label><input type="number" id="p_masaAsma" value="-101">
      </div>
    </div>
  <div class="section-title">Ceza Puanlaması</div>
  <div style="display:flex;gap:0px;">
    <div style="width:50%;">
      <label>İşlek Atma (+)</label><input type="number" id="c_islek" value="101">
      <label>Okey Kaptırma (+)</label><input type="number" id="c_okeykaptir" value="101">
    </div>
    <div style="width:50%;">
      <label>Hatalı Açma (+)</label><input type="number" id="c_hatali" value="101">
    </div>
  </div>
  <button class="btn" onclick="oyunaBasla()">Hesaplama Tablosu Oluştur</button>
</div>

<!-- ?? OYUN EKRANI -->
<div class="container hidden" id="oyunEkrani">
  <div id="oyunBilgisi"></div>
  <table id="skorTablo"></table>
  <button class="btn" onclick="yeniOyun()">Yeni Tablo Oluştur</button>
</div>

<script>
//---------------------------------------------------------------------------------------
function oyunTuruDegisti(){
	const tur=document.getElementById("oyunTuru").value;
	const tip=document.getElementById("esliTipi")
		?document.getElementById("esliTipi").value
		:"birlikte";
	const esliSecenekleri=document.getElementById("esliSecenekleri");
	const isimler=document.getElementById("isimler");
	if(tur==="esli") {
		esliSecenekleri.classList.remove("hidden");
	} else {
		esliSecenekleri.classList.add("hidden");
	}
	if(tur==="tek"||(tur==="esli"&&tip==="ayri")){
		isimler.innerHTML=`
			<div class="oyuncu-grup">
				<div><label>Oyuncu 1:</label><input id="oy1" value="Oyuncu 1"></div>
				<div><label>Oyuncu 2:</label><input id="oy2" value="Oyuncu 2"></div>
				<div><label>Oyuncu 3:</label><input id="oy3" value="Oyuncu 3"></div>
				<div><label>Oyuncu 4:</label><input id="oy4" value="Oyuncu 4"></div>
			</div>`;
	} else {
		isimler.innerHTML=`
			<label>Takım 1:</label><input id="oy1" value="Takım 1">
			<label>Takım 2:</label><input id="oy3" value="Takım 2">`;
	}
}
oyunTuruDegisti();

function oyunaBasla(){
	const turSayisi = parseInt(document.getElementById("tur").value);
	const oyuncular = Array.from(document.querySelectorAll("#isimler input")).map(i => i.value);
	const oyunTuru = document.getElementById("oyunTuru").value;
	const esliTipi = document.getElementById("esliTipi")? document.getElementById("esliTipi").value: "birlikte";
	const esliAyrı = (oyunTuru === "esli" && esliTipi === "ayri");
	window.esliAyrı = esliAyrı;
	document.getElementById("ayarEkrani").classList.add("hidden");
	document.getElementById("oyunEkrani").classList.remove("hidden");
	let oyunBilgiMetni = "";
	if (oyunTuru === "tek") {
		oyunBilgiMetni = "Tekli";
	} else {
		// Eşli ise tipine göre yaz
		if (esliTipi === "birlikte") {
			oyunBilgiMetni = "Eşli (Beraber)";
		} else {
			oyunBilgiMetni = "Eşli (Ayrı Ayrı)";
		}
	}
	document.getElementById("oyunBilgisi").innerHTML = `<h3>${oyunBilgiMetni} ${turSayisi} tur</h3>`;

	let html="<tr><th>El</th>";
	oyuncular.forEach(o=>html+=`<th>${o}</th>`);
	html+="</tr>";
	for(let el=1;el<=turSayisi;el++){
		html+=`<tr><td><b>${el}</b></td>`;
		oyuncular.forEach((o,idx)=>{
			html+=`<td id='cell_${el}_${idx}' class='player-cell'>
				<div class='kategori kat1'>
				  <h4>Açma Durumu</h4>
				  <span class='secenek acmadi'>Açamadı</span>
				  <span>Elinde: <input type='number' class='elinde' min='0' max='200'></span>
				</div>
				<div class='kategori kat2'>
				  <h4>Bitme Türü</h4>
				  <span class='secenek bitme'>Bitti</span>
				  <span class='secenek bitme'>Elden Bitti</span>
				  <span class='secenek bitme'>Çiftle Bitti</span>
				  <span class='secenek okey hidden'>Okey ile</span>
				</div>
				<div class='kategori kat3'>
				  <h4>Masa Aşımı / Cezalar</h4>
				  <span class='secenek masa'>Masa Aştı</span>
				  <div class='ceza-satiri'>İşlek Atma:
					<button class='azalt'>-</button>
					<span class='deger islek'>0</span>
					<button class='artir'>+</button>
				  </div>
				  <div class='ceza-satiri'>Hatalı Açma:
					<button class='azalt'>-</button>
					<span class='deger hatali'>0</span>
					<button class='artir'>+</button>
				  </div>
				  <div class='ceza-satiri'>Okey Kaptırma:
					<button class='azalt'>-</button>
					<span class='deger kaptir'>0</span>
					<button class='artir'>+</button>
				  </div>
				</div>
			  </td>`;
		});
		html+="</tr>";
	}
	document.getElementById("skorTablo").innerHTML=html;
	aktiflestirDavranislar();
}

function aktiflestirDavranislar(){
	document.querySelectorAll(".player-cell").forEach(cell=>{
		const kat1=cell.querySelector(".kat1"), kat2=cell.querySelector(".kat2");
		const acmadi=kat1.querySelector(".acmadi"), elinde=kat1.querySelector(".elinde");
		const bitmeler=kat2.querySelectorAll(".bitme");
		const okey=kat2.querySelector(".okey");
		const masaBtn=cell.querySelector(".masa");
		acmadi.addEventListener("click",()=>{
			const bitmisVar = biriBittiMi();
			if(!acmadi.classList.contains("aktif")){
				acmadi.classList.add("aktif");
				elinde.value = "";
				elinde.disabled = true;
				elinde.parentElement.style.display = "none";
				// sadece kat2’yi gizle, diğer işlemleri durdurma
				if (!bitmisVar) kat2.style.display = "none";
			} else {
				acmadi.classList.remove("aktif");
				elinde.disabled = false;
				elinde.parentElement.style.display = "inline-block";
				// sadece kat2’yi göster, bitmiş varsa dokunma
				if (!bitmisVar) kat2.style.display = "block";
			}
		});
		
		elinde.addEventListener("input",()=>{
			const val = elinde.value.trim();
			const bitmisVar = biriBittiMi();
			if(val !== "" && parseInt(val) > 0){
				acmadi.style.display = "none";
				if (!bitmisVar) kat2.style.display = "none";
			} else {
				acmadi.style.display = "inline-block";
				if (!bitmisVar) kat2.style.display = "block";
			}
		});

		bitmeler.forEach(bit=>{
			bit.addEventListener("click",()=>{
				const aktifMi = bit.classList.contains("aktif");
				bitmeler.forEach(b => {
					b.classList.remove("aktif"); 
					b.style.display = "inline-block"; 
				});
				
				const row = cell.parentElement; // <tr>
				const otherCells = row.querySelectorAll(".player-cell"); 
				if(aktifMi){
					kat1.style.display="block";
					okey.classList.add("hidden");
					okey.classList.remove("aktif");
					otherCells.forEach(c=>{
						const k1 = c.querySelector(".kat1");
						const k2 = c.querySelector(".kat2");
						const acmadiBtn = c.querySelector(".acmadi");
						const elindeInput = c.querySelector(".elinde");
						const acamadiAktif = acmadiBtn.classList.contains("aktif");
						const elindeVal = elindeInput.value;
						// kat1 her zaman görünür
						if (k1) k1.style.display = "block";
						// 🔹 kat2 görünürlük mantığı
						if (k2) {
							if (!acamadiAktif && elindeVal === "") {
								k2.style.display = "block";
							} else {
								k2.style.display = "none";
							}
						}
						// 🔹 "Açamadı" butonunun durumu
						if (acamadiAktif) {
							acmadiBtn.style.display = "inline-block";
						} else if (elindeVal === "") {
							acmadiBtn.style.display = "inline-block";
						} else {
							acmadiBtn.style.display = "none";
						}
						// Bitme butonlarını yeniden göster
						c.querySelectorAll(".bitme").forEach(b => b.style.display = "inline-block");
					});
					
					if(window.esliAyrı){
						const id = cell.id;
						const parca = id.split("_");
						const idx = parseInt(parca[2]);
						const takimEs = (idx % 2 === 0) ? idx + 1 : idx - 1;
						const takimCell = document.getElementById(`cell_${parca[1]}_${takimEs}`);
						if(takimCell){
							takimCell.querySelector(".kat1").style.display = "block";
							takimCell.querySelector(".kat2").style.display = "block";
						}
					}
				} else {
					bit.classList.add("aktif");
					kat1.style.display="none";
					const elInput = cell.querySelector(".elinde");
					if (elInput) elInput.value = "";
					bitmeler.forEach(b=>{if(b!==bit)b.style.display="none";});
					okey.classList.remove("hidden");
					otherCells.forEach(c=>{
						if(c === cell) return; // kendi hücremi atla
						// diğer hücrelerde bitme seçeneklerini gizle ve varsa aktiflerini temizle
						c.querySelectorAll(".bitme").forEach(b=>{
							b.classList.remove("aktif");
							b.style.display = "none";
						});

						const acmadiOther = c.querySelector(".acmadi");
						const elindeOther = c.querySelector(".elinde");
						// Eğer oyuncu zaten "Açamadı" durumundaysa, dokunma veya Oyuncu açamadı seçili değilse: (görünür kalsın)
						if (acmadiOther.classList.contains("aktif")) {
							acmadiOther.style.display = "inline-block";
						} else {
							// Elinde değeri boşsa gösterebilirsin veya Elinde değeri varsa gizle
							if (elindeOther.value === "") {
								acmadiOther.style.display = "inline-block";
							} else {
								acmadiOther.style.display = "none";
							}
						}
							// diğer hücrelerde el bilgilerini sıfırla / açma durumunu geri getir
							if (window.esliAyrı){
								const elindeOther = c.querySelector(".elinde");
								if (elindeOther) elindeOther.value = "";
							}
						const k2Other = c.querySelector(".kat2");
						if(k2Other) k2Other.style.display = "none"; // rakiplerin bitme alanını gizle
					});
					
					// 🟢 EŞLİ BİRLİKTE MODU: Takım arkadaşı işlemi
					if(window.esliAyrı){
						const id = cell.id; 
						const parca = id.split("_");
						const idx = parseInt(parca[2]); 
						const takimEs = (idx % 2 === 0) ? idx + 1 : idx - 1;
						const takimCell = document.getElementById(`cell_${parca[1]}_${takimEs}`);
						if(takimCell){
							const elinde = takimCell.querySelector(".elinde");
							const acmadi = takimCell.querySelector(".acmadi");
							const bitmeler2 = takimCell.querySelectorAll(".bitme");
							if(elinde) elinde.value = "";
							acmadi.classList.remove("aktif");
							acmadi.style.display = "inline-block";
							bitmeler2.forEach(b=>{b.classList.remove("aktif"); b.style.display="inline-block";});
							//takimCell.querySelector(".kat2").style.display="block";
							takimCell.querySelector(".kat1").style.display="none";
							takimCell.querySelector(".kat2").style.display="none";
						}
					}
				}
			});
		});
		
		okey.addEventListener("click",()=>{okey.classList.toggle("aktif");});
		masaBtn.addEventListener("click",()=>{masaBtn.classList.toggle("aktif");});

		const cezaSatirlari=cell.querySelectorAll(".ceza-satiri");
		cezaSatirlari.forEach(row=>{
			const azalt=row.querySelector(".azalt");
			const artir=row.querySelector(".artir");
			const deger=row.querySelector(".deger");
			azalt.addEventListener("click",()=>{
				let val=parseInt(deger.textContent);
				if(val>0)deger.textContent=val-1;
			});
			
			artir.addEventListener("click",()=>{
				let val=parseInt(deger.textContent);
				deger.textContent=val+1;
			});
			
		});
		
	});

	const rows=document.querySelectorAll("#skorTablo tr");
	rows.forEach((r,i)=>{
		if(i===0)return;
		r.querySelectorAll("input,.secenek,button").forEach(el=>{
			el.oninput=()=>kilitleOnceki(i);
			el.onclick=()=>kilitleOnceki(i);
		});
		
	});
	
}

function biriBittiMi(){
	return document.querySelectorAll(".bitme.aktif").length > 0;
}

function kilitleOnceki(satirIndex) {
	const rows = document.querySelectorAll("#skorTablo tr");
	if (satirIndex > 1) {
		const prev = rows[satirIndex - 1];
		const current = rows[satirIndex];
		const currentInputs = current.querySelectorAll("input, .secenek.aktif, .deger");
		const currentHasValue = [...currentInputs].some(el => {
			if (el.classList && el.classList.contains("deger")) return parseInt(el.textContent) > 0;
			if (el.tagName === "INPUT" && el.type === "number") return el.value !== "";
			return el.classList && el.classList.contains("aktif");
		});

		if (currentHasValue) {
			// 🔒 Önceki eli kilitle
			if (!prev.classList.contains("locked")) {
				prev.classList.add("locked");
				prev.querySelectorAll("input, .secenek, button").forEach(e => {
					e.disabled = true;
					e.style.pointerEvents = "none";
					e.style.opacity = "0.6";
					e.style.cursor = "not-allowed";
				});

				// Gri yap
				prev.querySelectorAll(".secenek.aktif").forEach(btn => {
					btn.style.backgroundColor = "#aaa";
					btn.style.color = "#fff";
				});

				prev.querySelectorAll(".elinde").forEach(inp => {
					const parent = inp.parentElement;
					inp.style.backgroundColor = "#ddd";
					inp.style.color = "#666";
					inp.style.borderColor = "#bbb";
					if (parent) parent.style.color = "#999";
				});

				prev.querySelectorAll(".ceza-satiri").forEach(row => {
					row.style.opacity = "0.6";
					row.querySelectorAll("button").forEach(btn => {
						btn.style.backgroundColor = "#bbb";
						btn.style.color = "#eee";
					});
				});
			}
		} else {
			// 🔓 Kilidi kaldır
			if (prev.classList.contains("locked")) {
				prev.classList.remove("locked");

				prev.querySelectorAll("input, .secenek, button").forEach(e => {
					e.disabled = false;
					e.style.pointerEvents = "";
					e.style.opacity = "";
					e.style.cursor = "";
				});

				// 🎨 Görseli tamamen sıfırla (aktif buton dahil)
				prev.querySelectorAll(".secenek").forEach(btn => {
					btn.style.backgroundColor = "";
					btn.style.color = "";
				});

				prev.querySelectorAll(".elinde").forEach(inp => {
					const parent = inp.parentElement;
					inp.style.backgroundColor = "#fff";
					inp.style.color = "";
					inp.style.borderColor = "#ccc";
					if (parent) parent.style.color = "";
				});

				prev.querySelectorAll(".ceza-satiri").forEach(row => {
					row.style.opacity = "";
					row.querySelectorAll("button").forEach(btn => {
						btn.style.backgroundColor = "";
						btn.style.color = "";
					});
				});
			}
		}
	}
}
//---------------------------------------------------------------------------------------

let toplamlar = []; // Her oyuncunun toplam puanı

function elTamamlandiMi(elIndex) {
  const tablo = document.getElementById("skorTablo");
  const satir = tablo.querySelectorAll("tr")[elIndex];
  if (!satir) return false;
  const hucreler = satir.querySelectorAll(".player-cell");
  return [...hucreler].every(cell => {
    const acmadi = cell.querySelector(".acmadi.aktif");
    const elinde = cell.querySelector(".elinde").value !== "";
    const bitme = cell.querySelector(".bitme.aktif");
    return acmadi || elinde || bitme;
  });
}

function hesaplaPuanlar() {
	const tablo = document.getElementById("skorTablo");
	const satirlar = tablo.querySelectorAll("tr");
	const oyuncuSayisi = satirlar[0].querySelectorAll("th").length - 1;

	toplamlar = new Array(oyuncuSayisi).fill(0);

	// 🔹 Her eli sırayla dolaş
	satirlar.forEach((satir, i) => {
		if (i === 0) return; // başlık satırını atla
		const hucreler = satir.querySelectorAll(".player-cell");

		// 🔹 O elde kim bitmiş ve okey ile bitmiş mi bul
		let okeyCarpani = 1;
		let bitenIndex = null;
		let bitmeTipi = "";

		hucreler.forEach((cell, idx) => {
			const bitme = [...cell.querySelectorAll(".bitme")].find(b => b.classList.contains("aktif"));
			const okey = cell.querySelector(".okey").classList.contains("aktif");
			if (bitme) {
				bitenIndex = idx;
				bitmeTipi = bitme.textContent;
				if (okey) {
					if (bitmeTipi.includes("Elden") || bitmeTipi.includes("Çift")) okeyCarpani = 4;
					else okeyCarpani = 2;
				}
			}
		});

		// 🔸 Her oyuncunun puanını hesapla
		hucreler.forEach((cell, j) => {
			let puanTemel = 0;
			let cezaToplam = 0;

			const acamadi = cell.querySelector(".acmadi").classList.contains("aktif");
			const elinde = parseInt(cell.querySelector(".elinde").value || 0);
			const bitme = [...cell.querySelectorAll(".bitme")].find(b => b.classList.contains("aktif"));
			const masaAsti = cell.querySelector(".masa").classList.contains("aktif");

			const P = {
				acamama: parseInt(document.getElementById("p_acamama").value),
				bitirme: parseInt(document.getElementById("p_bitirme").value),
				eldenbit: parseInt(document.getElementById("p_eldenbit").value),
				ciftbit: parseInt(document.getElementById("p_ciftbit").value),
				masaAsma: parseInt(document.getElementById("p_masaAsma").value),
			};

			const C = {
				islek: parseInt(cell.querySelector(".deger.islek").textContent),
				hatali: parseInt(cell.querySelector(".deger.hatali").textContent),
				kaptir: parseInt(cell.querySelector(".deger.kaptir").textContent),
				c_islek: parseInt(document.getElementById("c_islek").value),
				c_hatali: parseInt(document.getElementById("c_hatali").value),
				c_okeykaptir: parseInt(document.getElementById("c_okeykaptir").value),
			};

			// 🔸 PUANLAMA (temel puan)
			if (acamadi) puanTemel += P.acamama;
			if (elinde) puanTemel += elinde;
			if (bitme) {
				const tip = bitme.textContent;
				if (tip.includes("Elden")) puanTemel += P.eldenbit;
				else if (tip.includes("Çift")) puanTemel += P.ciftbit;
				else puanTemel += P.bitirme;
			}
			if (masaAsti) puanTemel += P.masaAsma;

			// 🔻 CEZALAR (sabit, çarpana dahil değil)
			cezaToplam =
				(C.islek * C.c_islek) +
				(C.hatali * C.c_hatali) +
				(C.kaptir * C.c_okeykaptir);

			// 🔹 Eğer OKEY İLE bitmiş biri varsa:
			// - Bitirenin kendi puanı değişmez
			// - Diğer oyuncuların temel puanı × okeyCarpani
			let toplamPuan;
			if (bitenIndex !== null && j !== bitenIndex && okeyCarpani > 1) {
			toplamPuan = (puanTemel * okeyCarpani) + cezaToplam;
			} else {
			toplamPuan = puanTemel + cezaToplam;
			}

			toplamlar[j] += toplamPuan;
		});
	});

  guncelleToplamGorunumu();
}

function guncelleToplamGorunumu() {
	let toplamDiv = document.getElementById("toplamPuanlar");
	if (!toplamDiv) {
		toplamDiv = document.createElement("div");
		toplamDiv.id = "toplamPuanlar";
		toplamDiv.className = "section-title";
		document.getElementById("oyunEkrani").appendChild(toplamDiv);
	}
	let html = "<h4>Toplam Puanlar</h4><table style='width:100%;text-align:center;border-collapse:collapse;'><tr>";
	const tablo = document.getElementById("skorTablo");
	const isimler = [...tablo.querySelectorAll("th")].slice(1).map(th => th.textContent);
	isimler.forEach((isim) => {
		html += `<th>${isim}</th>`;
	});
	html += "</tr><tr>";
	toplamlar.forEach(p => html += `<td>${p}</td>`);
	html += "</tr></table>";
	toplamDiv.innerHTML = html;
}

// 🔹 Oyun davranışları aktifken değişiklikleri dinle:
document.addEventListener("input", (e) => {
	if (e.target.closest(".player-cell")) {
    const td = e.target.closest("td");
    const id = td.id;
    const parca = id.split("_");
    const elNo = parseInt(parca[1]);

    hesaplaPuanlar();
	}
});

document.addEventListener("click", (e) => {
	if (e.target.closest(".secenek") || e.target.classList.contains("artir") || e.target.classList.contains("azalt")) {
		const td = e.target.closest("td");
		if (!td) return;
		const id = td.id;
		const parca = id.split("_");
		const elNo = parseInt(parca[1]);

		hesaplaPuanlar();
	}
});

// 🔹 LocalStorage verisini kaydet
function verileriKaydet() {
  const tablo = [];
  document.querySelectorAll("#skorTablo tr").forEach((tr, i) => {
    if (i === 0) return; // başlık satırını atla
    const elVeri = [];
    tr.querySelectorAll(".player-cell").forEach((cell) => {
      elVeri.push({
        acamadi: cell.querySelector(".acmadi").classList.contains("aktif"),
        elinde: cell.querySelector(".elinde").value,
        bitme: [...cell.querySelectorAll(".bitme")].find(b => b.classList.contains("aktif"))?.textContent || null,
        okey: cell.querySelector(".okey").classList.contains("aktif"),
        masa: cell.querySelector(".masa").classList.contains("aktif"),
        islek: cell.querySelector(".deger.islek").textContent,
        hatali: cell.querySelector(".deger.hatali").textContent,
        kaptir: cell.querySelector(".deger.kaptir").textContent,
      });
    });
    tablo.push(elVeri);
  });

  localStorage.setItem("okey101_veriJSON", JSON.stringify(tablo));

  const toplamlarData = JSON.stringify(toplamlar);
  localStorage.setItem("okey101_toplamlar", toplamlarData);
  localStorage.setItem("okey101_oyunAktif", !document.getElementById("oyunEkrani").classList.contains("hidden"));
}

// 🔹 LocalStorage verisini yükle
function verileriYukle() {
	window.esliAyrı = true; // Bu, sadece eşli-bireysel modu yeniden aktif eder
	document.getElementById("oyunBilgisi").innerHTML = `<h3>Eşli (Ayrı Ayrı)</h3>`;
  const oyunAktif = localStorage.getItem("okey101_oyunAktif") === "true";
  const tabloVeri = JSON.parse(localStorage.getItem("okey101_veriJSON") || "[]");
  if (!oyunAktif || tabloVeri.length === 0) return; // veri yoksa çık

  document.getElementById("ayarEkrani").classList.add("hidden");
  document.getElementById("oyunEkrani").classList.remove("hidden");

  // tabloyu JSON verisine göre yeniden oluştur
  const oyuncuSayisi = tabloVeri[0].length;
  const turSayisi = tabloVeri.length;

  // oyuncu adlarını tahmin et (eski kayıt yoksa varsayılan)
  const isimler = [];
  for (let i = 0; i < oyuncuSayisi; i++) isimler.push(`Oyuncu ${i + 1}`);

  let html = "<tr><th>El</th>";
  isimler.forEach(o => html += `<th>${o}</th>`);
  html += "</tr>";

  for (let el = 1; el <= turSayisi; el++) {
    html += `<tr><td><b>${el}</b></td>`;
    for (let idx = 0; idx < oyuncuSayisi; idx++) {
      html += `
      <td id='cell_${el}_${idx}' class='player-cell'>
        <div class='kategori kat1'>
          <h4>Açma Durumu</h4>
          <span class='secenek acmadi ${tabloVeri[el - 1][idx].acamadi ? "aktif" : ""}'>Açamadı</span>
          <span>Elinde: <input type='number' class='elinde' min='0' max='200' value='${tabloVeri[el - 1][idx].elinde || ""}'></span>
        </div>
        <div class='kategori kat2'>
          <h4>Bitme Türü</h4>
          <span class='secenek bitme ${tabloVeri[el - 1][idx].bitme === "Bitti" ? "aktif" : ""}'>Bitti</span>
          <span class='secenek bitme ${tabloVeri[el - 1][idx].bitme === "Elden Bitti" ? "aktif" : ""}'>Elden Bitti</span>
          <span class='secenek bitme ${tabloVeri[el - 1][idx].bitme === "Çiftle Bitti" ? "aktif" : ""}'>Çiftle Bitti</span>
          <span class='secenek okey ${tabloVeri[el - 1][idx].okey ? "aktif" : "hidden"}'>Okey ile</span>
        </div>
        <div class='kategori kat3'>
          <h4>Cezalar / Masa Aşımı</h4>
          <span class='secenek masa ${tabloVeri[el - 1][idx].masa ? "aktif" : ""}'>Masa Aştı</span>
          <div class='ceza-satiri'>İşlek Atma:
            <button class='azalt'>-</button>
            <span class='deger islek'>${tabloVeri[el - 1][idx].islek}</span>
            <button class='artir'>+</button>
          </div>
          <div class='ceza-satiri'>Hatalı Açma:
            <button class='azalt'>-</button>
            <span class='deger hatali'>${tabloVeri[el - 1][idx].hatali}</span>
            <button class='artir'>+</button>
          </div>
          <div class='ceza-satiri'>Okey Kaptırma:
            <button class='azalt'>-</button>
            <span class='deger kaptir'>${tabloVeri[el - 1][idx].kaptir}</span>
            <button class='artir'>+</button>
          </div>
        </div>
      </td>`;
    }
    html += "</tr>";
  }

  document.getElementById("skorTablo").innerHTML = html;
  aktiflestirDavranislar();

  toplamlar = JSON.parse(localStorage.getItem("okey101_toplamlar") || "[]");
  guncelleToplamGorunumu();
  
  // Yükledikten sonra mevcut dolu satırlara göre önceki elleri yeniden kilitle
const rows = document.querySelectorAll("#skorTablo tr");
for (let i = 2; i < rows.length; i++) {
  kilitleOnceki(i);
 
}

// 🩹 Yükleme sonrası hücre görünüm durumlarını düzelt
document.querySelectorAll(".player-cell").forEach(cell => {
  const acmadi = cell.querySelector(".acmadi");
  const elinde = cell.querySelector(".elinde");
  const bitmeler = cell.querySelectorAll(".bitme");
  const okey = cell.querySelector(".okey");
  const kat1 = cell.querySelector(".kat1");
  const kat2 = cell.querySelector(".kat2");

  const acmadiAktif = acmadi.classList.contains("aktif");
  const elVal = elinde.value.trim();
  const bitmeAktif = [...bitmeler].some(b => b.classList.contains("aktif"));

  // 🔸 Eğer biri bitti olarak işaretliyse kendi dışında herkesin kat2'si gizlenmeli
  if (bitmeAktif) {
    kat1.style.display = "none";
    okey.classList.remove("hidden");
    bitmeler.forEach(b => {
      if (!b.classList.contains("aktif")) b.style.display = "none";
    });
  } else {
    // Bitmemişse, açamadı ve elinde durumuna göre görünürlük ayarla
    if (acmadiAktif) {
      elinde.parentElement.style.display = "none";
      elinde.disabled = true;
      kat2.style.display = "none";
    } else if (elVal !== "") {
      acmadi.style.display = "none";
      kat2.style.display = "none";
    } else {
      // Hiçbiri seçilmediyse hepsi açık
      acmadi.style.display = "inline-block";
      elinde.parentElement.style.display = "inline-block";
      elinde.disabled = false;
      kat2.style.display = "block";
    }
  }
});

// 🟩 Eşli-bireysel: Biri "Bitti" ise takım arkadaşı gizlensin
if (window.esliAyrı) {
  const rows = document.querySelectorAll("#skorTablo tr");
  rows.forEach((r, i) => {
    if (i === 0) return;
    const cells = r.querySelectorAll(".player-cell");
    cells.forEach((cell, idx) => {
      const bitmeAktif = cell.querySelector(".bitme.aktif");
      if (bitmeAktif) {
        const takimEs = (idx % 2 === 0) ? idx + 1 : idx - 1;
        const takimCell = cells[takimEs];
        if (takimCell) {
          takimCell.querySelector(".kat1").style.display = "none";
          takimCell.querySelector(".kat2").style.display = "none";
          takimCell.querySelector(".elinde").value = "";
          takimCell.querySelector(".acmadi").classList.remove("aktif");
        }
      }
    });
  });
}
}


// 🔹 Sayfa kapanmadan önce kaydet
window.addEventListener("beforeunload", () => {
  verileriKaydet();
});

// 🔹 Sayfa açıldığında yükle
window.addEventListener("load", () => {
  verileriYukle();
});

// 🔹 “Yeni Oyun” seçildiğinde kaydı temizle
function yeniOyun() {
  localStorage.removeItem("okey101_tablo");
  localStorage.removeItem("okey101_toplamlar");
  localStorage.removeItem("okey101_ayarlar");
  localStorage.removeItem("okey101_oyunAktif");
  localStorage.removeItem("okey101_elVerileri");
  localStorage.removeItem("okey101_veriJSON");
  document.getElementById("oyunEkrani").classList.add("hidden");
  document.getElementById("ayarEkrani").classList.remove("hidden");
  if (!document.getElementById("oyunEkrani") || document.getElementById("oyunEkrani").classList.contains("hidden")) return;

  
}

</script>
</body>
</html>
