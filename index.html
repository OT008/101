<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Okey 101 Eşli (Bireysel) Arayüz Taslağı</title>
<style>

input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type=number] {
  -moz-appearance: textfield;
}

body {
  font-family: "Segoe UI", sans-serif;
  background: #f3f6fb;
  color: #2c3e50;
  margin: 0;
  padding: 20px;
}

.container {
  max-width: 1100px;
  margin: auto;
  background: white;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  overflow: hidden;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  border: 1px solid #ddd;
  text-align: center;
  vertical-align: top;
  padding: 10px;
}

/* --- Başlık Satırı --- */
th {
  background: #4a90e2;
  color: white;
  font-weight: bold;
  font-size: 15px;
}

/* --- Oyuncu İsimleri --- */
.oyuncu-isim {
  background: transparent;
  border: none;
  outline: none;
  color: white;
  font-weight: 600;
  font-size: 15px;
  text-align: center;
  width: 100%;
}
.oyuncu-isim:focus {
  color: white;
  background: transparent;
}

/* --- Oyuncu Hücreleri --- */
.player-cell {
  background: #f9f9f9;
  border-radius: 6px;
  padding: 6px;
}

/* --- Açma Durumu Alanı --- */
.kategori {
  border: 1px solid #eee;
  background: #fff;
  margin-bottom: 6px;
  border-radius: 6px;
  padding: 4px;
}
.kategori h4 {
  margin: 4px 0;
  color: #4a90e2;
  font-size: 13px;
}
.secenek {
  display: inline-flex;
  align-items: stretch;
  justify-content: center;
  vertical-align: middle;

  min-height: 28px;        /* sabit yükseklik */
  padding: 4px 12px;       /* metin çevresinde denge */
  box-sizing: border-box;  /* padding'i yüksekliğe dahil et */
  
  background: #4a90e2;
  color: white;
  border-radius: 6px;
  margin: 2px;
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  line-height: normal;     /* fontun dikey hizasını doğal bırak */
  transition: background 0.2s;
}

.secenek:hover {
  background: #357abd;
}
.secenek.aktif {
  background: #2ecc71;
}

/* --- Kalan Girişi (tıklayınca açılacak input için stil) --- */
.kalan-input {
  width: 50px;
  text-align: center;
  font-weight: bold;
  color: white;
  background: #4a90e2;
  border: none;
  outline: none;
  border-radius: 6px;
  font-size: 13px;
}

/* --- Cezalar Alanı --- */
.ceza-satiri {
  margin: 4px 0;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-size: 13px;
}
.ceza-satiri button {
  width: 24px;
  height: 24px;
  border: none;
  border-radius: 5px;
  color: white;
  font-weight: bold;
  cursor: pointer;
}
.ceza-satiri .azalt { background: #e74c3c; }
.ceza-satiri .artir { background: #2ecc71; }
.ceza-satiri span {
  font-weight: bold;
  color: #2c3e50;
}
/* --- Genel buton --- */
.btn {
  background: #e74c3c;
  color: #fff;
  border: none;
  padding: 10px 14px;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
  margin: 16px auto;
  display: block;
}
.btn:hover { opacity: .9; }

/* --- Masa Sayısı Butonu --- */
.masa-btn {
  display: inline-block;
  background: #4a90e2;
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s;
}
.masa-btn:hover { background: #357abd; }
.masa-btn.aktif { background: #2ecc71; }

/* --- Toplam Puanlar Satırı --- */
tfoot td {
  background: #eef4ff;
  font-weight: bold;
  font-size: 15px;
  color: #2c3e50;
  border-top: 2px solid #4a90e2;
}
tfoot td:first-child {
  background: #4a90e2;
  color: white;
}
</style>
</head>
<body>

<div class="container">
  <table>
    <thead>
      <tr>
        <th>El</th>
        <th><input type="text" class="oyuncu-isim" placeholder="Oyuncu 1"></th>
        <th><input type="text" class="oyuncu-isim" placeholder="Oyuncu 2"></th>
        <th><input type="text" class="oyuncu-isim" placeholder="Oyuncu 3"></th>
        <th><input type="text" class="oyuncu-isim" placeholder="Oyuncu 4"></th>
      </tr>
    </thead>

    <tbody>
      <tr>
        <td><b>1</b></td>

        <td class="player-cell">
          <div class="kategori">
            <h4>Açma Durumu</h4>
            <div class="secenek">Açamadı</div>
            <div class="secenek kalan">Kalan</div>
            <div class="secenek">Bitti</div>
          </div>
          <div class="kategori">
            <h4>Cezalar</h4>
            <div class="masa-btn">Masa Sayısı</div>
            <div class="ceza-satiri">İşlek:
              <button class="azalt">-</button>
              <span>0</span>
              <button class="artir">+</button>
            </div>
            <div class="ceza-satiri">Hatalı Açma:
              <button class="azalt">-</button>
              <span>0</span>
              <button class="artir">+</button>
            </div>
            <div class="ceza-satiri">Okey Kaptırma:
              <button class="azalt">-</button>
              <span>0</span>
              <button class="artir">+</button>
            </div>
          </div>
        </td>

        <td class="player-cell">
          <div class="kategori">
            <h4>Açma Durumu</h4>
            <div class="secenek">Açamadı</div>
            <div class="secenek kalan">Kalan</div>
            <div class="secenek">Bitti</div>
          </div>
          <div class="kategori">
            <h4>Cezalar</h4>
            <div class="masa-btn">Masa Sayısı</div>
            <div class="ceza-satiri">İşlek:
              <button class="azalt">-</button><span>0</span><button class="artir">+</button>
            </div>
            <div class="ceza-satiri">Hatalı Açma:
              <button class="azalt">-</button><span>0</span><button class="artir">+</button>
            </div>
            <div class="ceza-satiri">Okey Kaptırma:
              <button class="azalt">-</button><span>0</span><button class="artir">+</button>
            </div>
          </div>
        </td>

        <td class="player-cell">
          <div class="kategori">
            <h4>Açma Durumu</h4>
            <div class="secenek">Açamadı</div>
            <div class="secenek kalan">Kalan</div>
            <div class="secenek">Bitti</div>
          </div>
          <div class="kategori">
            <h4>Cezalar</h4>
            <div class="masa-btn">Masa Sayısı</div>
            <div class="ceza-satiri">İşlek:
              <button class="azalt">-</button><span>0</span><button class="artir">+</button>
            </div>
            <div class="ceza-satiri">Hatalı Açma:
              <button class="azalt">-</button><span>0</span><button class="artir">+</button>
            </div>
            <div class="ceza-satiri">Okey Kaptırma:
              <button class="azalt">-</button><span>0</span><button class="artir">+</button>
            </div>
          </div>
        </td>

        <td class="player-cell">
          <div class="kategori">
            <h4>Açma Durumu</h4>
            <div class="secenek">Açamadı</div>
            <div class="secenek kalan">Kalan</div>
            <div class="secenek">Bitti</div>
          </div>
          <div class="kategori">
            <h4>Cezalar</h4>
            <div class="masa-btn">Masa Sayısı</div>
            <div class="ceza-satiri">İşlek:
              <button class="azalt">-</button><span>0</span><button class="artir">+</button>
            </div>
            <div class="ceza-satiri">Hatalı Açma:
              <button class="azalt">-</button><span>0</span><button class="artir">+</button>
            </div>
            <div class="ceza-satiri">Okey Kaptırma:
              <button class="azalt">-</button><span>0</span><button class="artir">+</button>
            </div>
          </div>
        </td>
      </tr>
    </tbody>

    <tfoot>
      <tr>
        <td>Toplam</td>
        <td>0</td>
        <td>0</td>
        <td>0</td>
        <td>0</td>
      </tr>
    </tfoot>
  </table>
  <button class="btn" id="btnYeniOyun">Yeni Oyun</button>
</div>

<script>


// =========================  KAYDET / YÜKLE / SIFIRLA  =========================
const LS_KEY = 'okey101_state_v1';

function stateTopla() {
  const state = {
    oyuncuIsimleri: Array.from(document.querySelectorAll('thead .oyuncu-isim'))
      .map(inp => inp.value || ''),
    eller: [],
  };

  document.querySelectorAll('tbody tr').forEach((tr) => {
    const el = [];
    tr.querySelectorAll('.player-cell').forEach((cell) => {
      const acmaKat = cell.querySelector('.kategori'); // ilk kategori
      const acmadi = acmaKat?.querySelector('[data-role="acmadi"]')?.classList.contains('aktif') || false;

      const kalanInput = cell.querySelector('.kalan-input');
      const kalanDeger = kalanInput && kalanInput.value ? parseInt(kalanInput.value,10) : null;

      const bittiBtn = acmaKat?.querySelector('[data-role="bitti"]')?.classList.contains('aktif') || false;
      const okey = cell.querySelector('.bitti-ekstra .okey')?.classList.contains('aktif') || false;
      const elden = cell.querySelector('.bitti-ekstra .elden')?.classList.contains('aktif') || false;

      const masa = cell.querySelector('.masa-btn')?.classList.contains('aktif') || false;
      const cezalar = Array.from(cell.querySelectorAll('.ceza-satiri span')).map(sp => parseInt(sp.textContent||'0',10)||0);

      el.push({ acmadi, kalanDeger, bittiBtn, okey, elden, masa, cezalar });
    });
    state.eller.push(el);
  });
    const pasifEller = [];
  document.querySelectorAll('tbody tr').forEach((tr, idx) => {
    const ilkEl = tr.querySelector('.player-cell .secenek');
    // Eğer satırdaki ilk seçenek butonu pasifse (pointer-events: none)
    if (ilkEl && getComputedStyle(ilkEl).pointerEvents === 'none') {
      pasifEller.push(idx);
    }
  });
  state.pasifEller = pasifEller;

  return state;
}

function stateUygula(state) {
  if (!state || !state.eller?.length) return;

  // 1. Oyuncu isimleri
  const isimInputlari = document.querySelectorAll('thead .oyuncu-isim');
  state.oyuncuIsimleri?.forEach((ad, i) => { if (isimInputlari[i]) isimInputlari[i].value = ad; });

  const tbody = document.querySelector('tbody');
  
  // 2. El sayısını eşitle (gerekenden azsa yeniElEkle ile çoğalt)
  while (tbody.querySelectorAll('tr').length < state.eller.length) {
    yeniElEkle(); // Bu yeni satır eklerken roleriAta'yı da çağırır.
  }

  // 3. Tüm hücreleri “temiz” baza çek (Geri yüklemeden önce temizlik)
  tbody.querySelectorAll('tr').forEach((tr) => {
    tr.querySelectorAll('.secenek').forEach(s => { s.classList.remove('aktif'); s.style.display = 'inline-block'; });
    tr.querySelectorAll('.kalan-input').forEach(i => i.remove());
    tr.querySelectorAll('.bitti-ekstra').forEach(e => e.remove());
    tr.querySelectorAll('.masa-btn').forEach(b => { b.classList.remove('aktif'); b.style.display = 'inline-block'; });
    tr.querySelectorAll('.ceza-satiri span').forEach(sp => sp.textContent = '0');
    tr.querySelectorAll('.player-cell .kategori').forEach(k => { k.style.display = 'block'; });

    // Kalan butonu yoksa geri ekle (handleBitti'de silinmiş olabilir)
    tr.querySelectorAll('.player-cell').forEach(cell => {
      const acmaKat = cell.querySelector('.kategori');
      if (acmaKat && !acmaKat.querySelector('[data-role="kalan"]')) {
          const kalanBtn = document.createElement('div');
          kalanBtn.className = 'secenek kalan';
          kalanBtn.dataset.role = 'kalan';
          kalanBtn.textContent = 'Kalan';

          const bittiBtn = acmaKat.querySelector('[data-role="bitti"]');
          if (bittiBtn) {
            bittiBtn.insertAdjacentElement('beforebegin', kalanBtn);
          } else {
            acmaKat.appendChild(kalanBtn);
          }
      }
    });
  });

  // 4. Hücre hücre uygula
  const satirlar = tbody.querySelectorAll('tr');
  state.eller.forEach((el, rowIdx) => {
    const tr = satirlar[rowIdx];
    if (!tr) return;
    const cells = tr.querySelectorAll('.player-cell');

    el.forEach((h, colIdx) => {
      const cell = cells[colIdx];
      if (!cell) return;

      const acmaKat = cell.querySelector('.kategori');
      const acBtn   = acmaKat?.querySelector('[data-role="acmadi"]');
      const kalBtn  = acmaKat?.querySelector('[data-role="kalan"]'); // Kaldırılmamış butonu al
      const bitBtn  = acmaKat?.querySelector('[data-role="bitti"]');
      const masaBtn = cell.querySelector('.masa-btn');


      // Açamadı
      if (h.acmadi && acBtn) {
        acBtn.classList.add('aktif');
        if (kalBtn) kalBtn.style.display = 'none';
        if (bitBtn) bitBtn.style.display = 'none';
        if (masaBtn) masaBtn.style.display = 'none';
      }

      // Kalan
      if (h.kalanDeger && kalBtn) {
        // Butonu inputa çevir
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'kalan-input';
        input.min = '1'; input.max = '252';
        input.value = h.kalanDeger;
        kalBtn.replaceWith(input); // Butonu input ile değiştir
        if (acBtn) acBtn.style.display = 'none';
        if (bitBtn) bitBtn.style.display = 'none';
      } else if (h.kalanDeger && !kalBtn) {
          // Eğer Kalan butonu DOM'dan tamamen kaldırılmışsa (biten oyuncunun eşi gibi), 
          // bu durumda inputu koymaya gerek yok (ve zaten bitti mantığı devreye girecektir).
      }


      // Bitti (+ okey/elden paneli)
      if (h.bittiBtn && bitBtn) {
        // Önce normal Bitti işleminin temelini yap
        bitBtn.classList.add('aktif');
        if (acBtn) acBtn.style.display = 'none';
        
        // Kalan butonu inputa çevrilmediyse gizle, çevrildiyse zaten yerinde yok.
        const mevcutKalan = cell.querySelector('[data-role="kalan"], .kalan-input');
        if(mevcutKalan && mevcutKalan.tagName !== 'INPUT') mevcutKalan.style.display = 'none';
        
        // Okey/Elden paneli ekle
        let ekstraDiv = document.createElement('div');
        ekstraDiv.className = 'bitti-ekstra';
        ekstraDiv.style.marginTop = '6px';
        ekstraDiv.innerHTML = `
          <div class="secenek okey ${h.okey ? 'aktif' : ''}">Okey ile</div>
          <div class="secenek elden ${h.elden ? 'aktif' : ''}">Elden</div>
        `;
        acmaKat.insertAdjacentElement('afterend', ekstraDiv);
        
      }

      // Masa
      if (masaBtn && h.masa) masaBtn.classList.add('aktif');
      if (masaBtn && (h.acmadi || h.bittiBtn)) masaBtn.style.display = 'none'; // Biten/Açamayan da gizlenmeli (Bitti durumunda takımdan bağımsız)
      
      // Cezalar
      const spList = cell.querySelectorAll('.ceza-satiri span');
      h.cezalar?.forEach((val, i) => { if (spList[i]) spList[i].textContent = String(val||0); });
    });
    
    // 5. Biten oyuncunun takım arkadaşı ayarlamalarını yap
    // Bu kısım state'in geri yüklenmesi sırasında da Bitti mantığını simüle etmeli
    cells.forEach((cell, idx) => {
        const bitmeAktif = cell.querySelector('.secenek[data-role="bitti"].aktif');
        if (bitmeAktif) {
          const takimEs = (idx % 2 === 0) ? idx + 1 : idx - 1; // takım arkadaşı indeksi
          const takimCell = cells[takimEs];
          if (takimCell) {
            
            // 🔹 Takım arkadaşının Açma Durumu kategorisini gizle
            const acmaDurumu = takimCell.querySelector('.kategori:first-of-type'); 
            if (acmaDurumu) acmaDurumu.style.display = 'none';

            // 🔹 Bitti Ekstra (Okey/Elden) panelini gizle (varsa)
            const bittiEkstra = takimCell.querySelector('.bitti-ekstra');
            if (bittiEkstra) bittiEkstra.style.display = 'none';

            // 🔹 Elinde varsa inputu/butonu sil/gizle
            const elInput = takimCell.querySelector('.kalan-input');
            if (elInput) elInput.remove();
            
            const kalanBtn = takimCell.querySelector('[data-role="kalan"]');
            if (kalanBtn) kalanBtn.style.display = 'none'; // Kalan butonu varsa gizle

            // 🔹 Masa butonu görünür kalsın (ve aktif olmasın)
            const masaBtn = takimCell.querySelector('.masa-btn');
            if (masaBtn) {
              masaBtn.classList.remove('aktif');
              masaBtn.style.display = 'inline-block';
            }
            
            // Diğer oyuncuların Bitti butonlarını gizle (o an biten oyuncunun dışındakiler)
            tr.querySelectorAll('.player-cell').forEach(c => {
              if (c !== cell && c !== takimCell) {
                const bb = c.querySelector('[data-role="bitti"]');
                if (bb && !bb.classList.contains('aktif')) bb.style.display = 'none';
              }
            });
            
            // Takım arkadaşının cezalar dışındaki her şeyini sıfırla/gizle (Cezalar kategori başlığını da göster)
            const acmadiBtn = takimCell.querySelector('[data-role="acmadi"]');
            if (acmadiBtn) acmadiBtn.style.display = 'none';
            const bittiBtn = takimCell.querySelector('[data-role="bitti"]');
            if (bittiBtn) bittiBtn.style.display = 'none';
          }
        }
    });
  });

  // 6. Pasif elleri (kilitli eski elleri) tekrar pasifleştir
  const tumSatirlar = document.querySelectorAll('tbody tr');
  if (state.pasifEller && state.pasifEller.length) {
    state.pasifEller.forEach(i => {
      const tr = tumSatirlar[i];
      if (!tr) return;
      tr.querySelectorAll('.secenek, .masa-btn, .artir, .azalt, .kalan-input').forEach(el => {
        el.classList.add('pasif');
        el.style.pointerEvents = 'none';
        el.style.opacity = '0.5';
      });
    });
  }

  // 7. Son el boşsa bir önceki eli yeniden aktif yap (Kilitleme mantığını geri yükle)
  if (tumSatirlar.length >= 2) {
    const onceki = tumSatirlar[tumSatirlar.length - 2];
    const son = tumSatirlar[tumSatirlar.length - 1];

    const aktifVarMi = son.querySelector('.secenek.aktif, .masa-btn.aktif, .bitti-ekstra');
    const kalanInputVarMi = son.querySelector('.kalan-input');
    let cezaVarMi = false;
    son.querySelectorAll('.ceza-satiri span').forEach(sp => {
      if (parseInt(sp.textContent || '0', 10) > 0) cezaVarMi = true;
    });

    if (!aktifVarMi && !kalanInputVarMi && !cezaVarMi) {
      onceki.querySelectorAll('.secenek, .masa-btn, .artir, .azalt, .kalan-input').forEach(el => {
        el.classList.remove('pasif');
        el.style.pointerEvents = 'auto';
        el.style.opacity = '1';
      });
    } else {
         // Son el doluysa, bir önceki eli pasifleştir (Kayıtlı pasif el olmasa bile)
         onceki.querySelectorAll('.secenek, .masa-btn, .artir, .azalt, .kalan-input').forEach(el => {
            el.classList.add('pasif');
            el.style.pointerEvents = 'none';
            el.style.opacity = '0.5';
        });
    }
  }
  
  // 8. Skorları tazele
  toplamPuanHesapla();
}

function stateKaydet() {
  try {
    const s = stateTopla();
    localStorage.setItem(LS_KEY, JSON.stringify(s));
  } catch (e) {
    console.warn('Kaydetme hatası:', e);
  }
}

function stateYukle() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) {
       roleriAta(); // İlk yüklemede rolleri ata
       return;
    }
    const s = JSON.parse(raw);
    stateUygula(s);
    roleriAta(); // 👈 ÖNEMLİ: Geri yükleme sonrası tüm DOM'a rolleri yeniden ata
  } catch (e) {
    console.warn('Yükleme hatası:', e);
  }
}

function yeniOyunSifirla() {
  if (confirm("Yeni oyun başlatmak istediğinizden emin misiniz? Tüm skorlar sıfırlanacaktır.")) {
    localStorage.removeItem(LS_KEY);
    location.reload(); // en güvenlisi: sayfayı ilk haline al
  }
}

// --- Olaylara bağla: her tıklama ve input sonrası kaydet
document.addEventListener('click', (e) => {
  const hedef = e.target.closest('.secenek, .masa-btn, .artir, .azalt, .kalan-input');
  if (!hedef) return;
  // ufak bir gecikme; DOM değişikliği bittiğinde state alınsın
  setTimeout(stateKaydet, 0);
});
document.addEventListener('input', (e) => {
  if (e.target.closest('.kalan-input') || e.target.classList.contains('oyuncu-isim')) {
    setTimeout(stateKaydet, 0);
  }
});

// --- Yükle ve “Yeni Oyun” butonunu bağla
window.addEventListener('load', stateYukle);
document.getElementById('btnYeniOyun')?.addEventListener('click', yeniOyunSifirla);
// ===============================================================================
//-----------------------------------------------------------------------------------------↓
// --- Başlangıç: Açma Durumu üçlüsüne data-role ata ---
function roleriAta() {
  document.querySelectorAll('.player-cell .kategori:first-child').forEach(kat => {
    const opts = kat.querySelectorAll('.secenek');
    if (opts[0]) opts[0].dataset.role = 'acmadi';
    if (opts[1]) { opts[1].dataset.role = 'kalan'; opts[1].classList.add('kalan'); }
    if (opts[2]) opts[2].dataset.role = 'bitti';
  });
}

// roleriAta'yı burada çağırmak yerine, window.onload veya stateYukle içinde kontrol altına aldık.


// --- Yardımcı: hücre indexine göre takım arkadaşını bul ---
function takimEsIndex(cell) {
  const row = cell.closest('tr');
  const idx = Array.from(row.children).indexOf(cell);
  // El sütunu 0. index; oyuncular 1..4
  if (idx === 1) return 2;
  if (idx === 2) return 1;
  if (idx === 3) return 4;
  if (idx === 4) return 3;
  return null;
}

function handleAcmadi(btn) {
  const kat = btn.closest('.kategori');
  const cell = btn.closest('.player-cell');
  const kalan = kat.querySelector('[data-role="kalan"]');
  const bitti = kat.querySelector('[data-role="bitti"]');
  const masaBtn = cell.querySelector('.masa-btn');
  const kalanInput = cell.querySelector('.kalan-input'); // Ek: kalan input varsa sil

  const acikMi = btn.classList.toggle('aktif');

  if (acikMi) {
    // Buton aktif oldu → diğerlerini gizle
    if (kalanInput) kalanInput.remove(); // Input varsa kaldır
    if (kalan) kalan.style.display = 'none';
    if (bitti) bitti.style.display = 'none';
    if (masaBtn) masaBtn.style.display = 'none';
  } else {
    // Buton pasif oldu → diğerlerini geri göster
    if (kalan) kalan.style.display = 'inline-block';
    if (bitti) bitti.style.display = 'inline-block';
    if (masaBtn) masaBtn.style.display = 'inline-block';
  }
}

function handleKalan(btn) {
  const kat = btn.closest('.kategori');
  const acamadi = kat.querySelector('[data-role="acmadi"]');
  const bitti = kat.querySelector('[data-role="bitti"]');

  // Açamadı ve Bitti butonlarını gizle
  if (acamadi) acamadi.style.display = 'none';
  if (bitti) bitti.style.display = 'none';

  // Input oluştur
  const input = document.createElement('input');
  input.type = 'number';
  input.className = 'kalan-input';
  input.min = '1';
  input.max = '252';
  input.placeholder = '0';

  // Butonun yerini input alır
  btn.replaceWith(input);
  input.focus();

  // Input odak kaybedince kontrol et
  input.addEventListener('blur', () => {
    if (!input.value || +input.value < 1) {
      // Değer yoksa: inputu kaldır, butonu geri getir
      input.replaceWith(btn);
      if (acamadi) acamadi.style.display = 'inline-block';
      if (bitti) bitti.style.display = 'inline-block';
      // Tekrar kayıt tetikle
      setTimeout(stateKaydet, 0); 
      toplamPuanHesapla();
    } else {
      // Değer varsa: inputu kalıcı hale getir
      input.value = String(Math.min(252, Math.max(1, +input.value)));
      input.style.color = 'white';
      input.style.fontWeight = 'bold';
      // Tekrar kayıt tetikle
      setTimeout(stateKaydet, 0); 
      toplamPuanHesapla();
    }
  });
}

function handleBitti(btn) {
  const cell = btn.closest('.player-cell');
  const row = cell.closest('tr');
  const acmaKat = cell.querySelector('.kategori');
  const acamadi = acmaKat.querySelector('[data-role="acmadi"]');
  const kalanBtn = acmaKat.querySelector('[data-role="kalan"]');
  const masaBtn = cell.querySelector('.masa-btn');
  const aktifmiydi = btn.classList.contains('aktif');
  const esIdx = takimEsIndex(cell);

  // 🔹 İlk tıklama (aktifleşme)
  if (!aktifmiydi) {
    btn.classList.add('aktif');

    // Kendi butonlarını gizle ve inputu kaldır (varsa)
    const kalanInput = cell.querySelector('.kalan-input');
    if (kalanInput) kalanInput.remove();
    if (acamadi) acamadi.style.display = 'none';
    if (kalanBtn) kalanBtn.style.display = 'none';
    if (masaBtn) masaBtn.style.display = 'none'; // Biten kendi masasını da gizler

    // Okey/Elden panelini ekle
    const ekstraDiv = document.createElement('div');
    ekstraDiv.className = 'bitti-ekstra';
    ekstraDiv.style.marginTop = '6px';
    ekstraDiv.innerHTML = `
      <div class="secenek okey">Okey ile</div>
      <div class="secenek elden">Elden</div>
    `;
    acmaKat.insertAdjacentElement('afterend', ekstraDiv);

    // Diğer oyuncuların Bitti butonlarını gizle
    row.querySelectorAll('.player-cell').forEach(c => {
      if (c !== cell) {
        const b = c.querySelector('[data-role="bitti"]');
        if (b && !b.classList.contains('aktif')) b.style.display = 'none';
      }
    });

    // 🔧 Takım arkadaşını sıfırla + gizle + MASA'yı nötrle ve görünür yap
    if (esIdx) {
      const esCell = row.children[esIdx];
      const esAcma = esCell.querySelector('.kategori:first-of-type'); // Sadece açma kategorisi
      const esMasa = esCell.querySelector('.masa-btn');
      const esKalanInput = esCell.querySelector('.kalan-input');
      const esBittiEkstra = esCell.querySelector('.bitti-ekstra');
      
      if (esKalanInput) esKalanInput.remove(); // Kalan input varsa sil
      if (esBittiEkstra) esBittiEkstra.remove(); // Bitti ekstra varsa sil

      if (esAcma) {
        // Tüm seçenekleri pasif yap
        esAcma.querySelectorAll('.secenek').forEach(s => s.classList.remove('aktif'));
        // Açma kategorisini gizle
        esAcma.style.display = 'none';
      }
      if (esMasa) {
        esMasa.classList.remove('aktif');
        esMasa.style.display = 'inline-block'; // MASA'yı görünür yap
      }
      
      // Takım arkadaşının diğer oyunculara ait Bitti butonunu geri gösterme/gizleme mantığını da simüle etmeli (gerek yok, zaten Bitti butonu gizlenecek)
    }

  // 🔸 İkinci tıklama (geri alma)
  } else {
    btn.classList.remove('aktif');

    // Okey/Elden panelini kaldır
    const ekstra = cell.querySelector('.bitti-ekstra');
    if (ekstra) ekstra.remove();

    // Kendi butonlarını geri getir
    if (acamadi) acamadi.style.display = 'inline-block';
    if (kalanBtn) kalanBtn.style.display = 'inline-block';
    if (masaBtn) { masaBtn.classList.remove('aktif'); masaBtn.style.display = 'inline-block'; }

    // Diğer oyuncuların Bitti butonlarını geri getirirken kontrol yap
    row.querySelectorAll('.player-cell').forEach(c => {
      const b = c.querySelector('[data-role="bitti"]');
      const acmadiBtn = c.querySelector('[data-role="acmadi"]');
      const kalanBtn2 = c.querySelector('[data-role="kalan"]');
      const kalanInput = c.querySelector('.kalan-input');

      const aktifAcmadi = acmadiBtn && acmadiBtn.classList.contains('aktif');
      const aktifBitti = b && b.classList.contains('aktif'); // Başka biri bitmişse gizli kalmalı
      const kalanDegerGirildi = Boolean(kalanInput && kalanInput.value);

      if (b && !aktifBitti) {
        if (aktifAcmadi || kalanDegerGirildi) {
          b.style.display = 'none';
        } else {
          b.style.display = 'inline-block';
        }
      }
      
      // Takım arkadaşı için özel olarak, onun bitti butonu da geri gelmeli.
      if (c === row.children[esIdx]) {
        if (b) b.style.display = 'inline-block';
      }
    });

    // Takım arkadaşını geri getir ve sıralı şekilde sıfırla
    if (esIdx) {
      const esCell = row.children[esIdx];
      const esAcma = esCell.querySelector('.kategori:first-of-type');
	  const esMasa = esCell.querySelector('.masa-btn');
      if (esAcma) {
        esAcma.style.display = 'block';

        // Tüm butonları aktiflikten çıkar ve görünür hale getir
        ['acmadi','kalan','bitti'].forEach(r => {
          const el = esAcma.querySelector(`[data-role="${r}"]`);
          if (el) {
            el.classList.remove('aktif');
            el.style.display = 'inline-block';
          }
        });
      }
      if (esMasa) esMasa.style.display = 'inline-block';
    }
  }
}


document.addEventListener('click', (e) => {
  const btn = e.target.closest('.secenek, .masa-btn, .artir, .azalt');
  if (!btn) return;

  // --- AÇAMADI ---
  if (btn.dataset.role === 'acmadi') {
  handleAcmadi(btn);
  return;
}
  // --- KALAN (buton) -> inputa dönüşecek ---
if (btn.dataset.role === 'kalan') {
  handleKalan(btn);
  return;
}
//-----------------------------------------------------------------------------------------↑
  // --- BİTTİ (toggle) ---
if (btn.dataset.role === 'bitti') {
  handleBitti(btn);
  return;
}
//-----------------------------------------------------------------------------------------↓
  // --- OKEY / ELDEN (Bitti sonrası çıkanları tıkla) ---
  if (btn.classList.contains('okey') || btn.classList.contains('elden')) {
    btn.classList.toggle('aktif'); // birlikte de seçilebilir
    return;
  }

  // --- MASA SAYISI (toggle) ---
  if (btn.classList.contains('masa-btn')) {
    btn.classList.toggle('aktif');
    return;
  }

  // --- CEZA BUTONLARI (artır/azalt, min 0) ---
  if (btn.classList.contains('artir') || btn.classList.contains('azalt')) {
    const satir = btn.closest('.ceza-satiri');
    if (!satir) return;

    const degerEl = satir.querySelector('span');
    let val = parseInt(degerEl?.textContent || '0', 10) || 0;

    if (btn.classList.contains('artir')) {
      val += 1;
    } else {
      val = Math.max(0, val - 1); // min 0
    }

    degerEl.textContent = String(val);
    return;
  }
});
//-----------------------------------------------------------------------------------------↑
function tumOyuncularAldiMi(row) {
  const cells = row.querySelectorAll('.player-cell');
  // Tüm hücrelerin (veya takım eşinin) bir durumu (Açamadı, Kalan, Bitti) kaydettiğinden emin ol.
  return Array.from(cells).every(cell => {
    const acmaKat = cell.querySelector('.kategori:first-of-type');
    if (!acmaKat) return true; // Eğer kategori yoksa (bitenin eşi gibi), tamamdır.
    
    const aktif = acmaKat.querySelector('.secenek.aktif') || cell.querySelector('.kalan-input');
    const bitti = cell.querySelector('[data-role="bitti"]')?.classList.contains('aktif');
    
    // El bitmişse (bitti aktifse), diğer elemanlara bakmaya gerek yok
    if (bitti) return true; 

    // Cezalar ve Masa (ekstra cezalar da elin bittiği anlamına gelebilir, ancak burada sadece skor girişi kontrol edilir)
    let cezaVarMi = false;
    cell.querySelectorAll('.ceza-satiri span').forEach(sp => {
        if (parseInt(sp.textContent || '0', 10) > 0) cezaVarMi = true;
    });
    const masaAktif = cell.querySelector('.masa-btn')?.classList.contains('aktif');

    // Eğer Açamadı, Kalan, Bitti (veya takımdan biri bitmiş) veya Ceza/Masa durumu varsa, o oyuncu "girişi tamamlanmış" sayılır.
    // Ancak, sadece Açamadı/Kalan/Bitti ile yeni ele geçilebilir. Cezalar tek başına yeni ele geçirtmemeli.
    
    const aktifDurumVar = Boolean(aktif);

    // Eğer takım arkadaşı bitmişse
    const esIdx = takimEsIndex(cell);
    if (esIdx !== null) {
        const esCell = row.children[esIdx];
        const esBitti = esCell.querySelector('[data-role="bitti"]')?.classList.contains('aktif');
        if (esBitti) return true;
    }

    // Ya aktif bir durum var (Açamadı/Kalan/Bitti) ya da takım arkadaşı bitmiş
    return aktifDurumVar; 
  });
}

// --- Yeni el ekleme fonksiyonu ---
function yeniElEkle() {
  const tbody = document.querySelector('tbody');
  const satirlar = tbody.querySelectorAll('tr');
  const sonSatir = satirlar[satirlar.length - 1];
  const yeniElNo = satirlar.length + 1;
  const yeniSatir = sonSatir.cloneNode(true);
  
  // Yeni satırı temizle
  yeniSatir.querySelector('td:first-child').innerHTML = `<b>${yeniElNo}</b>`;
  yeniSatir.querySelectorAll('.secenek').forEach(s => {
    s.classList.remove('aktif');
    s.style.display = 'inline-block';
  });
  yeniSatir.querySelectorAll('.kalan-input').forEach(i => i.remove());
  yeniSatir.querySelectorAll('.bitti-ekstra').forEach(e => e.remove());
  yeniSatir.querySelectorAll('.masa-btn').forEach(b => {
    b.classList.remove('aktif');
    b.style.display = 'inline-block';
  });
  yeniSatir.querySelectorAll('.ceza-satiri span').forEach(sp => sp.textContent = '0');
  yeniSatir.querySelectorAll('.player-cell .kategori').forEach(k => {
    k.style.display = 'block';
  });
  
  // Kalan butonu eksikse geri ekle
  yeniSatir.querySelectorAll('.player-cell').forEach(cell => {
    const acmaKat = cell.querySelector('.kategori');
    let kalanBtn = acmaKat.querySelector('[data-role="kalan"]');
    if (acmaKat && !kalanBtn) {
      kalanBtn = document.createElement('div');
      kalanBtn.className = 'secenek kalan';
      kalanBtn.dataset.role = 'kalan';
      kalanBtn.textContent = 'Kalan';
      const bittiBtn = acmaKat.querySelector('[data-role="bitti"]');
      if (bittiBtn) bittiBtn.insertAdjacentElement('beforebegin', kalanBtn);
    }
  });

  tbody.appendChild(yeniSatir);
  roleriAta(); // Yeni eklenen satırın butonlarına rolleri at
}

// Her tıklamadan sonra yeni el kontrolü
document.addEventListener('click', (e) => {
  const hedef = e.target.closest('.secenek, .masa-btn, .artir, .azalt');
  if (!hedef) return;
  
  // Kalan inputta Enter'a basılınca veya blur olunca da tetiklenebilir
  setTimeout(() => {
    const tbody = document.querySelector('tbody');
    const satirlar = tbody.querySelectorAll('tr');
    const sonSatir = satirlar[satirlar.length - 1];

    if (tumOyuncularAldiMi(sonSatir)) {
      yeniElEkle();
      stateKaydet(); // Yeni el eklenince kaydet
    }
  }, 100);
});

document.addEventListener('click', (e) => {
  const hedef = e.target.closest('.secenek, .masa-btn, .artir, .azalt');
  if (!hedef) return;

  const aktifSatirlar = document.querySelectorAll('tbody tr');
  if (aktifSatirlar.length < 2) return;

  const tiklananSatir = hedef.closest('tr');
  const tiklananIndex = Array.from(aktifSatirlar).indexOf(tiklananSatir);
  const sonIndex = aktifSatirlar.length - 1;
  const oncekiSatir = aktifSatirlar[sonIndex - 1];
  const sonSatir = aktifSatirlar[sonIndex];

  // 🔹 1. Yeni el aktif olunca önceki eli pasifleştir
  if (tiklananIndex === sonIndex) {
    oncekiSatir.querySelectorAll('.secenek, .masa-btn, .artir, .azalt, .kalan-input').forEach(el => {
      el.classList.add('pasif');
      el.style.pointerEvents = 'none';
      el.style.opacity = '0.5';
    });
  }

  // 🔹 2. Her tıklamadan sonra kontrol: son elde hiç seçim kalmadıysa, önceki eli geri aktif et
  setTimeout(() => {
    const aktifVarMi = sonSatir.querySelector('.secenek.aktif, .masa-btn.aktif, .bitti-ekstra');
    const kalanInputVarMi = sonSatir.querySelector('.kalan-input');
    let cezaVarMi = false;
    sonSatir.querySelectorAll('.ceza-satiri span').forEach(sp => {
      if (parseInt(sp.textContent || '0', 10) > 0) cezaVarMi = true;
    });

    // Eğer hiçbir aktif seçim, input ya da ceza yoksa:
    if (!aktifVarMi && !kalanInputVarMi && !cezaVarMi) {
      oncekiSatir.querySelectorAll('.secenek, .masa-btn, .artir, .azalt, .kalan-input').forEach(el => {
        el.classList.remove('pasif');
        el.style.pointerEvents = 'auto';
        el.style.opacity = '1';
      });
    }
    toplamPuanHesapla();
  }, 100);
});

document.addEventListener('input', (e) => {
  const input = e.target.closest('.kalan-input');
  if (!input) {
      // Oyuncu isimleri değişince de puan hesaplansın (gerekmez ama tutarlılık için)
      if (e.target.classList.contains('oyuncu-isim')) {
          setTimeout(toplamPuanHesapla, 0);
      }
      return;
  }

  const row = input.closest('tr');
  const tbody = row.closest('tbody');
  const satirlar = tbody.querySelectorAll('tr');
  const sonIndex = satirlar.length - 1;
  const sonSatir = satirlar[sonIndex];
  const oncekiSatir = satirlar[sonIndex - 1];

  // Eğer bu input son eldeyse ve tamamen temizlendiyse:
  if (row === sonSatir && input.value.trim() === '') {
    // Diğer aktif elemanlar da yoksa geri aktif yap
    const aktifVarMi = sonSatir.querySelector('.secenek.aktif, .masa-btn.aktif, .bitti-ekstra');
    let cezaVarMi = false;
    sonSatir.querySelectorAll('.ceza-satiri span').forEach(sp => {
      if (parseInt(sp.textContent || '0', 10) > 0) cezaVarMi = true;
    });

    if (!aktifVarMi && !cezaVarMi && satirlar.length >= 2) {
      oncekiSatir.querySelectorAll('.secenek, .masa-btn, .artir, .azalt, .kalan-input').forEach(el => {
        el.classList.remove('pasif');
        el.style.pointerEvents = 'auto';
        el.style.opacity = '1';
      });
    }
  }
  
  // Yeni el kontrolü:
  setTimeout(() => {
    if (tumOyuncularAldiMi(sonSatir)) {
      yeniElEkle();
      stateKaydet(); 
    }
  }, 100);

  toplamPuanHesapla();
});

// 🔹 TOPLAM PUAN HESAPLAMA FONKSİYONU
function toplamPuanHesapla() {
  const tbody = document.querySelector('tbody');
  const satirlar = tbody.querySelectorAll('tr');
  const toplamlar = [0, 0, 0, 0]; // Oyuncu 1-4 toplam puanları

  satirlar.forEach(row => {
    const hucreler = row.querySelectorAll('.player-cell');
    let bitenIndex = null;
    let carpim = 1;

    // 🔹 Önce kimin "bitti" olduğunu ve çarpanı tespit et
    hucreler.forEach((cell, i) => {
      const bittiBtn = cell.querySelector('.secenek[data-role="bitti"].aktif');
      const okey = cell.querySelector('.bitti-ekstra .okey.aktif');
      const elden = cell.querySelector('.bitti-ekstra .elden.aktif');

      if (bittiBtn) {
        bitenIndex = i;
        if (okey && elden) carpim = 4;
        else if (okey || elden) carpim = 2;
        else carpim = 1;
      }
    });

    const elPuanlari = [0, 0, 0, 0];

    // 🔸 Her oyuncunun puanını hesapla
    hucreler.forEach((cell, i) => {
      const acmadi = cell.querySelector('.secenek[data-role="acmadi"].aktif');
      const kalanInput = cell.querySelector('.kalan-input');
      const bittiBtn = cell.querySelector('.secenek[data-role="bitti"].aktif');
      const okey = cell.querySelector('.bitti-ekstra .okey.aktif');
      const elden = cell.querySelector('.bitti-ekstra .elden.aktif');
      const masa = cell.querySelector('.masa-btn.aktif');
      const cezalar = cell.querySelectorAll('.ceza-satiri span');

      let puan = 0;

      // 🟢 Açma durumuna göre
      if (acmadi) puan += 202;
      else if (kalanInput && kalanInput.value) puan += parseInt(kalanInput.value);
      else if (bittiBtn) {
        if (okey && elden) puan -= 202;
        else if (okey) puan -= 101;
        else if (elden) puan -= 202;
        else puan -= 101;
      }

      // 🔸 Masa cezası
      if (masa) puan += 101; // Masa (masayı açtırmadan oynamak) ceza puanı (eksi değil artı) olmalı
      
      // Biten oyuncu için Masa/Okey/Elden puanı 101/202/404 zaten yukarıda Bitti butonu tıklandığında düşülüyor (-101/ -202 / -404)
      
      // 🔸 Cezalar (çarpan dışında)
      cezalar.forEach(span => {
        const adet = parseInt(span.textContent || '0', 10);
        if (adet > 0) puan += adet * 101;
      });

      elPuanlari[i] = puan;
    });

    // 🔹 Takım eşleri
    const takimEs = { 0: 1, 1: 0, 2: 3, 3: 2 };

    // 🔸 Biten oyuncu varsa özel durumlar
    if (bitenIndex !== null) {
      const esIndex = takimEs[bitenIndex];
      
      // Takım arkadaşı sıfır alır (sadece ceza hariç)
      const esCell = hucreler[esIndex];
      let cezaToplam = 0;

      // Takım arkadaşının cezalarını topla (Masa, İşlek, Hatalı Açma, Okey Kaptırma)
      const masa = esCell.querySelector('.masa-btn.aktif');
      if (masa) cezaToplam += 101;

      const cezalar = esCell.querySelectorAll('.ceza-satiri span');
      cezalar.forEach(span => {
        const adet = parseInt(span.textContent || '0', 10);
        if (adet > 0) cezaToplam += adet * 101;
      });
      elPuanlari[esIndex] = cezaToplam; // Sadece ceza etkileri kalır (0 veya pozitif)

      // Diğer iki oyuncunun puanı çarpılır (Biten oyuncu ve takım arkadaşı dışındakiler)
      hucreler.forEach((_, i) => {
        if (i !== bitenIndex && i !== esIndex) {
          elPuanlari[i] *= carpim;
        }
      });
    }
    // 🔹 Toplamları ekle
    elPuanlari.forEach((p, i) => toplamlar[i] += p);
  });

  // 🔸 Alt kısımdaki “Toplam” satırını güncelle
  const tfoot = document.querySelector('tfoot tr:last-child');
  if (tfoot) {
    const tds = tfoot.querySelectorAll('td');
    toplamlar.forEach((t, i) => {
      if (tds[i + 1]) tds[i + 1].textContent = t;
    });
  }
}
</script>
</body>
</html>
